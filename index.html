<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Riegos LoRa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  body { font-family: Arial; text-align:center; margin:20px; background:#f4f4f4; }
  h2 { color:#333; margin-bottom:20px; }
  .panel-maestra {
    background:#fff; padding:15px; margin:10px auto;
    border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2);
    max-width:400px; text-align:center;
  }
  .accordion {
    background:white; padding:15px; margin:10px auto;
    border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2);
    cursor:pointer; max-width:500px; text-align:left;
  }
  .panel {
    padding:15px; display:none;
    background:#e9e9e9; margin-top:10px;
    border-radius:5px; text-align:center;
  }
  button {
    padding:10px 20px; margin:5px;
    border:none; border-radius:5px;
    font-weight:bold; cursor:pointer;
    font-size:16px;
  }
  .on { background-color:#4CAF50; color:white; }
  .off { background-color:#f44336; color:white; }
  .timer-btn { background-color: #0077cc; color:white; transition: background 0.2s; }
  .timer-btn:hover { background-color: #005fa3; }
  .estado { font-weight:bold; padding:2px 6px; border-radius:4px; }
  .estado.ON { background-color:#4CAF50; color:white; }
  .estado.OFF { background-color:#f44336; color:white; }
  .estado.DESCONECTADO { background-color:#999; color:white; }
  input[type=time] { padding:5px; margin:5px; font-size:14px; }
  .sensor-box {
    background:#fff; padding:10px; margin:10px auto;
    border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15);
    max-width:300px;
  }
  .sensor-box h4 { margin:5px 0; }
  .sensor-value { font-size:1.4em; font-weight:bold; }
  .temp { color:#0077cc; }
  .hum { color:#009688; }
</style>
</head>
<body>

<h2>üíß Panel de Control de Riegos LoRa</h2>

<!-- V√°lvula maestra siempre visible con estilo acorde√≥n -->
<div style="
    background:white;
    padding:15px;
    margin:10px auto;
    border-radius:10px;
    box-shadow:0 4px 8px rgba(0,0,0,0.2);
    max-width:500px;
    text-align:left;
    display:inline-flex;       /* Usamos inline-flex para que el ancho se ajuste al contenido */
    gap:10px;                  /* Separaci√≥n entre texto y estado */
    align-items:center;
    cursor:default;
">
  <span>üö∞ V√°lvula Maestra</span>
  <span id="estadoMaestra" class="estado DESCONECTADO">DESCONECTADO</span>
</div>


<div id="riegos"></div>
<br>
<button class="timer-btn" onclick="consultarTodos()">üåê Consultar estado de todos los riegos</button>

<script>
// ======================== ESTADOS ========================
const estadosNodo = {};
for (let i = 1; i <= 8; i++) {
  estadosNodo[i] = { estado: "DESCONECTADO", temperatura: "-- ¬∞C", humedad: "-- %" };
}

// ======================== MQTT ========================
const client = mqtt.connect("wss://f5f8fae4d9aa4d8690cb5ff83429436c.s1.eu.hivemq.cloud:8884/mqtt", {
  username: "Lora123",
  password: "Lora1234"
});

client.on("connect", () => {
  console.log("‚úÖ Conectado al broker MQTT");
  for (let i = 1; i <= 8; i++) {
    client.subscribe(`campo1/riego${i}/estado`);
    client.subscribe(`campo1/riego${i}/temperatura`);
    client.subscribe(`campo1/riego${i}/humedad`);
  }
  client.subscribe("campo1/broadcast");
  client.subscribe("campo1/valvulaMaestra/estado"); // V√°lvula maestra

  consultarTodos();
});

client.on("message", (topic, message) => {
  const msg = message.toString();

  // ===== V√°lvula maestra =====
  if(topic === "campo1/valvulaMaestra/estado"){
    const span = document.getElementById("estadoMaestra");
    span.innerText = msg;
    span.className = `estado ${msg}`; // Cambia color seg√∫n estado
  }

  // ===== Estado nodos =====
  let match = topic.match(/riego(\d+)\/estado/);
  if (match) {
    const id = parseInt(match[1]);
    estadosNodo[id].estado = msg;
    const span = document.getElementById(`estado${id}`);
    span.innerText = msg;
    span.className = `estado ${msg}`;
  }

  // ===== Temperatura =====
  match = topic.match(/riego(\d+)\/temperatura/);
  if (match) {
    const id = parseInt(match[1]);
    estadosNodo[id].temperatura = msg + " ¬∞C";
    document.getElementById(`temp${id}`).innerText = estadosNodo[id].temperatura;
  }

  // ===== Humedad =====
  match = topic.match(/riego(\d+)\/humedad/);
  if (match) {
    const id = parseInt(match[1]);
    estadosNodo[id].humedad = msg + " %";
    document.getElementById(`hum${id}`).innerText = estadosNodo[id].humedad;
  }
});

// ======================== Crear interfaz ========================
const contenedor = document.getElementById("riegos");
for (let i = 1; i <= 8; i++) {
  contenedor.innerHTML += `
    <div class="accordion">üíß Riego ${i} - Estado: <span class="estado DESCONECTADO" id="estado${i}">${estadosNodo[i].estado}</span></div>
    <div class="panel">
      <div class="sensor-box">
        <h4>üå°Ô∏è Temperatura: <span class="sensor-value temp" id="temp${i}">${estadosNodo[i].temperatura}</span></h4>
        <h4>üíß Humedad: <span class="sensor-value hum" id="hum${i}">${estadosNodo[i].humedad}</span></h4>
      </div>

      <button class="on" onclick="enviarComando(${i}, 'ON')">ON</button>
      <button class="off" onclick="enviarComando(${i}, 'OFF')">OFF</button>
      <button class="timer-btn" onclick="consultarRiego(${i})">üîç Consultar estado</button>

      <div class="timer-section">
        <h4>‚è±Ô∏è Programar inicio y duraci√≥n</h4>
        <label>Hora de inicio:</label><br>
        <input type="time" id="horaInicio${i}" step="60" value="06:00"><br>
        <label>Duraci√≥n (HH:MM):</label><br>
        <input type="time" id="duracion${i}" step="60" value="00:30"><br>
        <button class="timer-btn" onclick="programarTemporizador(${i})">Programar temporizador</button>
        <div id="confirmacion${i}" style="margin-top:5px;color:#0077cc;font-weight:bold;"></div>
      </div>
    </div>
  `;
}

// ======================== Acordeones ========================
document.querySelectorAll(".accordion").forEach(acc => {
  acc.addEventListener("click", () => {
    const panel = acc.nextElementSibling;
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  });
});

// ======================== Funciones ========================
function enviarComando(num, cmd) {
  const topic = `campo1/riego${num}/comando`;
  const mensaje = cmd + num;
  client.publish(topic, mensaje);
  document.getElementById(`estado${num}`).innerText = "‚è≥ Enviando...";
}

function programarTemporizador(num) {
  const horaInicio = document.getElementById(`horaInicio${num}`).value;
  const duracion = document.getElementById(`duracion${num}`).value;
  if (!horaInicio || !duracion) { alert("‚ö†Ô∏è Ingresa una hora de inicio y duraci√≥n v√°lida"); return; }
  const mensaje = `STARTTIMER${num}:${horaInicio}-${duracion}`;
  client.publish(`campo1/riego${num}/comando`, mensaje);
  document.getElementById(`confirmacion${num}`).innerText =
    `‚úÖ Temporizador enviado: se encender√° a las ${horaInicio} durante ${duracion} (HH:MM)`;
}

function consultarRiego(num) {
  client.publish(`campo1/riego${num}/comando`, `status${num}?`);
  document.getElementById(`estado${num}`).innerText = "‚è≥ Consultando...";
}

function consultarTodos() {
  console.log("üì° Enviando broadcast para consultar estado de todos los nodos...");
  client.publish("campo1/broadcast", "STATUS_ALL");
  for (let i = 1; i <= 8; i++) {
    document.getElementById(`estado${i}`).innerText = "‚è≥ Consultando...";
  }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Riegos LoRa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: Arial; text-align:center; margin:20px; background:#f4f4f4; }
    h2 { color:#333; margin-bottom:20px; }
    .accordion { background:white; padding:15px; margin:10px auto; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2); cursor:pointer; max-width:500px; text-align:left; }
    .panel { padding:15px; display:none; background:#e9e9e9; margin-top:10px; border-radius:5px; text-align:center; }
    button { padding:10px 20px; margin:5px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; font-size:16px; }
    .on { background-color:#4CAF50; color:white; }
    .off { background-color:#f44336; color:white; }
    .estado { font-weight:bold; }
    .temp-box { max-width:400px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .temp-value { font-size:2em; color:#0077cc; font-weight:bold; }
    input[type=time] { padding:5px; margin:5px; font-size:14px; }
    .schedule { margin-top:10px; border-top:1px solid #ccc; padding-top:10px; }
    .franja { margin-bottom:5px; }
    .franja span { margin:0 5px; }
    .remove { color:red; cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>

<h2>üíß Panel de Control de Riegos LoRa</h2>

<div class="temp-box">
  <h3>üå°Ô∏è Temperatura actual</h3>
  <div class="temp-value" id="tempValue">-- ¬∞C</div>
</div>

<div id="riegos"></div>

<script>
  // ======================== MQTT ========================
  const client = mqtt.connect("wss://f5f8fae4d9aa4d8690cb5ff83429436c.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "Lora123",
    password: "Lora1234"
  });

  client.on("connect", () => {
    console.log("‚úÖ Conectado al broker MQTT");
    for (let i = 1; i <= 8; i++) client.subscribe(`campo1/riego${i}/estado`);
    client.subscribe("sensor/temperatura");
  });

  client.on("message", (topic, message) => {
    const msg = message.toString();
    if(topic.startsWith("campo1/riego")) {
      const id = topic.match(/\d+/)[0];
      document.getElementById(`estado${id}`).innerText = msg;
    }
    if(topic==="sensor/temperatura") document.getElementById("tempValue").innerText = `${msg} ¬∞C`;
  });

  // ======================== Riegos ========================
  const riegos = [];
  for(let i=1;i<=8;i++){
    riegos.push({
      id: i,
      estado: "OFF",
      horarios: [] // array de {inicio, fin}
    });
  }

  // ======================== Crear interfaz ========================
  const contenedor = document.getElementById("riegos");
  riegos.forEach(r=>{
    contenedor.innerHTML += `
      <div class="accordion">üíß Riego ${r.id} - Estado: <span class="estado" id="estado${r.id}">DESCONOCIDO</span></div>
      <div class="panel">
        <button class="on" onclick="enviarComando(${r.id}, 'ON')">ON</button>
        <button class="off" onclick="enviarComando(${r.id}, 'OFF')">OFF</button>
        <div class="schedule" id="schedule${r.id}">
          <h4>Programar horarios</h4>
          Inicio: <input type="time" id="inicio${r.id}"> Fin: <input type="time" id="fin${r.id}">
          <button onclick="agregarFranja(${r.id})">Agregar</button>
          <div id="franjas${r.id}"></div>
        </div>
      </div>
    `;
  });

  document.querySelectorAll(".accordion").forEach(acc=>{
    acc.addEventListener("click", ()=>{
      const panel = acc.nextElementSibling;
      panel.style.display = panel.style.display==="block"?"none":"block";
    });
  });

  // ======================== Funci√≥n enviar comando ========================
  function enviarComando(num, cmd){
    const topic = `campo1/riego${num}/comando`;
    client.publish(topic, cmd);
    document.getElementById(`estado${num}`).innerText = cmd;
    const riego = riegos.find(r=>r.id===num);
    riego.estado = cmd;
  }

  // ======================== Funci√≥n agregar franja horaria ========================
  function agregarFranja(num){
    const inicio = document.getElementById(`inicio${num}`).value;
    const fin = document.getElementById(`fin${num}`).value;
    if(!inicio || !fin) return alert("Debes seleccionar hora de inicio y fin");

    const riego = riegos.find(r=>r.id===num);
    const idFranja = Date.now();
    riego.horarios.push({inicio, fin, id:idFranja});

    actualizarFranjas(num);
  }

  // ======================== Funci√≥n actualizar lista de franjas ========================
  function actualizarFranjas(num){
    const riego = riegos.find(r=>r.id===num);
    const cont = document.getElementById(`franjas${num}`);
    cont.innerHTML = "";
    riego.horarios.forEach(f=>{
      cont.innerHTML += `<div class="franja">
        <span>${f.inicio} ‚Üí ${f.fin}</span> 
        <span class="remove" onclick="eliminarFranja(${num},${f.id})">X</span>
      </div>`;
    });
  }

  // ======================== Funci√≥n eliminar franja ========================
  function eliminarFranja(num,id){
    const riego = riegos.find(r=>r.id===num);
    riego.horarios = riego.horarios.filter(f=>f.id!==id);
    actualizarFranjas(num);
  }

  // ======================== Revisar horarios ========================
  setInterval(()=>{
    const ahora = new Date();
    const h = ahora.getHours().toString().padStart(2,"0");
    const m = ahora.getMinutes().toString().padStart(2,"0");
    const tiempo = `${h}:${m}`;

    riegos.forEach(r=>{
      let encendido = false;
      r.horarios.forEach(f=>{
        if(tiempo>=f.inicio && tiempo< f.fin) encendido = true;
      });
      if(encendido && r.estado!=="ON") enviarComando(r.id,"ON");
      if(!encendido && r.estado!=="OFF") enviarComando(r.id,"OFF");
    });
  },60000);

</script>
</body>
</html>
<!DOCTYPE html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Riegos LoRa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body { font-family: Arial; text-align:center; margin:20px; background:#f4f4f4; }
    h2 { color:#333; margin-bottom:20px; }
    .accordion {
      background:white; padding:15px; margin:10px auto;
      border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2);
      cursor:pointer; max-width:500px; text-align:left;
    }
    .panel {
      padding:15px; display:none;
      background:#e9e9e9; margin-top:10px;
      border-radius:5px; text-align:center;
    }
    button {
      padding:10px 20px; margin:5px;
      border:none; border-radius:5px;
      font-weight:bold; cursor:pointer;
      font-size:16px;
    }
    .on { background-color:#4CAF50; color:white; }
    .off { background-color:#f44336; color:white; }
    .estado { font-weight:bold; }
    input[type=time] { padding:5px; margin:5px; font-size:14px; }
    .schedule { margin-top:10px; border-top:1px solid #ccc; padding-top:10px; }
    .franja { margin-bottom:5px; }
    .franja span { margin:0 5px; }
    .remove { color:red; cursor:pointer; font-weight:bold; }
    .sensor-box {
      background:#fff; padding:10px; margin:10px auto;
      border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15);
      max-width:300px;
    }
    .sensor-box h4 { margin:5px 0; }
    .sensor-value { font-size:1.4em; font-weight:bold; }
    .temp { color:#0077cc; }
    .hum { color:#009688; }
  </style>
</head>
<body>

<h2>üíß Panel de Control de Riegos LoRa</h2>

<!-- ü™Ñ Ya no hay cuadro global de temperatura -->
<div id="riegos"></div>

<script>
  // ======================== MQTT ========================
  const client = mqtt.connect("wss://f5f8fae4d9aa4d8690cb5ff83429436c.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "Lora123",
    password: "Lora1234"
  });

  client.on("connect", () => {
    console.log("‚úÖ Conectado al broker MQTT");

    // Nos suscribimos a todos los estados, temperaturas y humedades
    for (let i = 1; i <= 8; i++) {
      client.subscribe(`campo1/riego${i}/estado`);
      client.subscribe(`campo1/riego${i}/temperatura`);
      client.subscribe(`campo1/riego${i}/humedad`);
    }
  });

  client.on("message", (topic, message) => {
    const msg = message.toString();
    console.log("üì©", topic, msg);

    // Actualizar estado ON/OFF
    if (topic.includes("/estado")) {
      const id = topic.match(/\d+/)[0];
      document.getElementById(`estado${id}`).innerText = msg;
    }

    // Actualizar temperatura espec√≠fica
    if (topic.includes("/temperatura")) {
      const id = topic.match(/\d+/)[0];
      document.getElementById(`temp${id}`).innerText = `${msg} ¬∞C`;
    }

    // Actualizar humedad espec√≠fica
    if (topic.includes("/humedad")) {
      const id = topic.match(/\d+/)[0];
      document.getElementById(`hum${id}`).innerText = `${msg} %`;
    }
  });

  // ======================== Riegos ========================
  const riegos = [];
  for(let i=1;i<=8;i++){
    riegos.push({
      id: i,
      estado: "OFF",
      horarios: [] // array de {inicio, fin, id}
    });
  }

  // ======================== Crear interfaz ========================
  const contenedor = document.getElementById("riegos");
  riegos.forEach(r=>{
    contenedor.innerHTML += `
      <div class="accordion">üíß Riego ${r.id} - Estado: <span class="estado" id="estado${r.id}">DESCONOCIDO</span></div>
      <div class="panel">
        <!-- üìä Sensor box -->
        <div class="sensor-box">
          <h4>üå°Ô∏è Temperatura: <span class="sensor-value temp" id="temp${r.id}">-- ¬∞C</span></h4>
          <h4>üíß Humedad: <span class="sensor-value hum" id="hum${r.id}">-- %</span></h4>
        </div>

        <!-- üîò Control manual -->
        <button class="on" onclick="enviarComando(${r.id}, 'ON')">ON</button>
        <button class="off" onclick="enviarComando(${r.id}, 'OFF')">OFF</button>
        
        <!-- üåø Temporizador -->
        <div class="timer-section">
          <h4>‚è±Ô∏è Encender con temporizador</h4>

        <!-- Cambiamos el input a type="time" con segundos -->
        <input 
          type="time" 
          id="timer${r.id}" 
          step="1" 
          value="00:00:00"> 
        <!-- step="1" permite segundos -->

        <!-- üëá Explicaci√≥n del formato -->
        <div style="font-size: 0.9em; color: #555; margin-top: 4px;">
          Formato: <strong>HH:MM:SS</strong> (ej: 01:30:00 para 1h 30min)
        </div>

        <button onclick="activarTemporizador(${r.id})">Activar temporizador</button>
        <div id="contador${r.id}" style="margin-top:5px;color:#0077cc;font-weight:bold;"></div>
        </div>
      </div>
    `;
  });

  // ======================== Acordeones ========================
  document.querySelectorAll(".accordion").forEach(acc=>{
    acc.addEventListener("click", ()=>{
      const panel = acc.nextElementSibling;
      panel.style.display = panel.style.display==="block"?"none":"block";
    });
  });

  // ======================== Enviar comando ON/OFF ========================
  function enviarComando(num, cmd){
    const topic = `campo1/riego${num}/comando`;
    client.publish(topic, cmd);
    document.getElementById(`estado${num}`).innerText = cmd;
    const riego = riegos.find(r=>r.id===num);
    riego.estado = cmd;
  }

function activarTemporizador(num) {
  const tiempoInput = document.getElementById(`timer${num}`).value;

  if (!tiempoInput) {
    alert("‚è±Ô∏è Ingresa un tiempo v√°lido en formato HH:MM:SS");
    return;
  }

  // üî¢ Separar horas, minutos y segundos
  const [h, m, s] = tiempoInput.split(":").map(Number);
  const tiempoTotal = (h * 3600) + (m * 60) + s;

  if (tiempoTotal <= 0) {
    alert("‚è±Ô∏è El tiempo debe ser mayor a 0");
    return;
  }

  // üöø Enviar comando ON con duraci√≥n al riego
  enviarComando(num, `TIMER:${tiempoTotal}`);

  // üîî Mostrar mensaje simple de confirmaci√≥n
  const contadorDiv = document.getElementById(`contador${num}`);
  contadorDiv.innerText = `‚è±Ô∏è Temporizador enviado al riego ${num}`;
}


</script>
</body>
</html>
